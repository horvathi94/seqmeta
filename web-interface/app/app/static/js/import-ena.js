let EMPTY_ATTRIBUTE={};async function fetchEmptyAttribute(){const e=await fetch("/templates/attributes?for=empty");var n=await e.json();EMPTY_ATTRIBUTE=n[0]}function string2XML(e){return(new window.DOMParser).parseFromString(e,"text/xml")}async function fetchEnaXml(e){return string2XML(await fetch("https://www.ebi.ac.uk/ena/browser/api/xml/"+e).then(e=>e.text()))}function clearEnaInfo(){const e=document.querySelector("#ena-info");e.querySelectorAll("p").forEach(e=>{e.remove()})}function appendEnaInfo(e,n){const t=document.querySelector("#ena-info"),r=document.createElement("p");r.innerHTML=`<strong>${e}:</strong>`+n,t.appendChild(r)}function updateType(e,n){e.querySelector(".cell.type>.attr.field.type_").value=n,changedAttributeType(e)}function cleanNameField(e){return clean=e.replace(/[ /-]/g,"_").replace(/[()]/g,"")}function field2Attribute(e){const n=Object.create(EMPTY_ATTRIBUTE),t=(n.ena_name=e.querySelector("NAME").innerHTML,e.querySelector("LABEL").innerHTML),r=(n.general_name=cleanNameField(n.ena_name),n.label=t.slice(0,1).toUpperCase()+t.slice(1).toLowerCase(),n.description=e.querySelector("DESCRIPTION").innerHTML,n.ena_requirement=e.querySelector("MANDATORY").innerHTML,e.querySelector("FIELD_TYPE").children[0]);let a;switch(r.tagName){case"TEXT_FIELD":const a=r.querySelector("REGEX_VALUE");null!==a&&(n.pattern=a.innerHTML);break;case"TEXT_AREA_FIELD":break;case"TEXT_CHOICE_FIELD":n.type_="select",n.options=Array.from(r.querySelectorAll("TEXT_VALUE")).map(e=>e.querySelector("VALUE").innerHTML)}const c=e.querySelector("UNITS");return c&&(n.ena_units=Array.from(c.querySelectorAll("UNIT")).map(e=>e.innerHTML)),n}function parseFieldGroup(e){Array.from(e.querySelectorAll("FIELD")).forEach(e=>{const n=TEMPLATE_EDITOR.appendAttributeRow();e=field2Attribute(e);n.fillFromField(e)})}async function parseXmlChecklist(){var e=document.querySelector("#ena-import > #ena-checklist").value;const n=await fetchEnaXml(e),t=n.querySelector(`CHECKLIST_SET > CHECKLIST[checklistType='Sample'][accession='${e}']`);if(null!==t)if(t.querySelector("IDENTIFIERS>PRIMARY_ID").innerHTML==e){const r=t.querySelector("DESCRIPTOR");clearEnaInfo(),appendEnaInfo("Label",r.querySelector("LABEL").innerHTML),appendEnaInfo("Name",r.querySelector("NAME").innerHTML),appendEnaInfo("Description",r.querySelector("DESCRIPTION").innerHTML),appendEnaInfo("Authority",r.querySelector("AUTHORITY").innerHTML),Array.from(t.querySelectorAll("FIELD_GROUP")).forEach(e=>{parseFieldGroup(e)})}else alert("Mismatch in accession number!");else alert("Mismatch in accession number!")}function fetchEnaData(){parseXmlChecklist(),TEMPLATE_EDITOR.lockEnaChecklist()}fetchEmptyAttribute();