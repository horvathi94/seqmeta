SAMPLE_ATTRIBUTE={general_name:"",label:"",description:"",type_:"text"};class SampleEditor{constructor(e){this.table=e,this.head=this.table.tHead,this.tab=this.table.tBodies[0],this._template=null,this._fields=[],this.lastIndex=0}get fields(){return this._fields}append_fields(e){this._fields=this._fields.concat(e)}get template(){return this._template}set template(e){this._template=e,this.append_fields(e.fields),this.append_fields(e.file_fields.filter(e=>e.is_active)),this._fields.forEach(e=>{this.appendBlankRow(e)})}createLabelCell(e){const t=document.createElement("th");return t.textContent=e,t}createDescriptionCell(e){const t=document.createElement("td");return t.innerHTML=e,t}createEditAllCell(e){const t=document.createElement("td");t.classList.add("editall");let a;return e.is_unique?t.textContent="Unique value":("file"==e.type_?a=createEditAllFileField(e):(a=createAttributeField(e,"",null,!0)).onchange=function(){this.closest("tr").querySelectorAll("td.sample").forEach(e=>{e.querySelector(".attrfield").value=this.value}),SAMPLE_EDITOR.updateSampleTemplate(this)},t.appendChild(a)),t}appendBlankRow(e){const t=this.tab.insertRow();t.dataset.generalName=e.general_name,t.appendChild(this.createLabelCell(e.label)),t.appendChild(this.createEditAllCell(e)),t.appendChild(this.createDescriptionCell(e.description))}get samplesHeader(){return this.head.querySelector("#samples-header-cell")}get sampleCount(){return this.getRow("sample_name").querySelectorAll("td.sample").length}stretchHeader(e){this.samplesHeader.colSpan=e,this.samplesHeader.style.display=0==e?"none":""}getRow(e){return this.tab.querySelector(`tr[data-general-name='${e}']`)}get currentIndex(){return this.lastIndex+1}uniqCheckCompareAllFields(e){const a=e.querySelectorAll("td.sample");let l,s,n,r=!0;for(let t=0;t<a.length;t++){l=a[t].querySelector(".attrfield"),n=!0;for(let e=0;e<a.length;e++)if(t!=e&&(s=a[e].querySelector(".attrfield"),l.value==s.value)){n=!1,r=!1;break}n?l.style.color="black":l.style.color="red"}return r}async checkAgainstSaved(e,t,a){let l=`/samples/list-attributes/?template_name=${this.template.name}&attribute_name=`+t;e&&(l+="&skip="+e);const s=await fetch(l).then(e=>e.json());return!s.includes(a)}async checkIfUnique(e){var t=e.closest("td"),a=(t.dataset.sample,t.parentElement),l=this.uniqCheckCompareAllFields(a),t=await this.checkAgainstSaved(t.dataset.savedName,a.dataset.generalName,e.value);e.style.color=t?"black":"red",l&&t?this.enableSave():this.disableSave()}get removeSampleButton(){const e=document.createElement("input");return e.type="button",e.value="X",e.onclick=function(){var e=this.parentElement.dataset.sample;SAMPLE_EDITOR.removeSample(e)},e}addAttributeCell(e,t=null,a,l){const s=this.getRow(e.general_name).insertCell(a);s.classList.add("sample"),"template"==e.type_&&s.classList.add("template"),s.dataset.sample=this.currentIndex,s.dataset.savedName=l;a=`sample+${this.currentIndex}+`+e.general_name,l=createAttributeField(e,a,t);s.appendChild(l),"sample_name"==e.general_name&&s.appendChild(this.removeSampleButton)}removeSample(e){this.tab.querySelectorAll(`td[data-sample='${e}']`).forEach(e=>{e.remove()});this.stretchHeader(this.sampleCount)}addSample(l=null){const s=this.sampleCount+2;this.fields.forEach(t=>{let e=null;null!==l&&0<l.attributes.length&&void 0!==(a=l.attributes.find(e=>e.general_name==t.general_name))&&(e=a.value);var a=null!==l?l.name:"";this.addAttributeCell(t,e,s,a)}),this.stretchHeader(this.sampleCount),this.lastIndex++}checkSample(t){let a=0;return this.getRow("sample_name").querySelectorAll("td.sample>input.attrfield").forEach(e=>{e.value==t&&(a=parseInt(e.name.split("+")[1]))}),a}addSampleFromFile(e){const t=e.name.split(".")[0];var e=t.split("_")[0];this.checkSample(e)||(e={attributes:[{general_name:"sample_name",value:e}]},SAMPLE_EDITOR.addSample(e))}updateTemplate(e){const t=e.querySelector(".attrfield"),a=e.dataset.sample,l=parseTemplateString(t.dataset.templateString);l.filter(e=>"const"!=e.type).forEach(e=>{var t=e.value;e.fieldValue=this.getRow(t).querySelector(`td.sample[data-sample='${a}']`).querySelector(".attrfield").value}),t.value=constructStringFromTemplate(l)}updateSampleTemplate(e){const t=e.closest("td");let a="td.sample.template";t.classList.contains("editall")||(a+=`[data-sample='${t.dataset.sample}']`),this.tab.querySelectorAll(a).forEach(e=>{this.updateTemplate(e)})}get saveButton(){return document.querySelector("#save-samples-button")}disableSave(){this.saveButton.disabled=!0}enableSave(){this.saveButton.disabled=!1}}function addBlankSample(){const l=parseInt(SAMPLE_EDITOR.rows[1].querySelectorAll("td.sample").length)+1;return TEMPLATE.attributes.forEach(e=>{const t=SAMPLE_EDITOR.querySelector(`tr[data-general-name='${e.general_name}']`),a=t.insertCell(t.cells.length-1);a.classList.add("sample"),a.dataset.sample=l,a.appendChild(createAttributeField(e))}),l}async function initTable(){const t=document.querySelector("#template-name").value,e=(SAMPLE_EDITOR.template=await fetch(`/templates/json?name=${t}&use=sample_editor`).then(e=>e.json()).then(e=>e),document.querySelector("#sample-names").value.split(","));e&&e.forEach(e=>{e&&fetch(`/samples/json?name=${e}&template_name=`+t).then(e=>e.json()).then(e=>SAMPLE_EDITOR.addSample(e))})}const table=document.querySelector("#sample-editor"),SAMPLE_EDITOR=new SampleEditor(table);initTable();