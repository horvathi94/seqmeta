SAMPLE_ATTRIBUTE={general_name:"",label:"",description:"",type_:"text"};class SampleEditor{constructor(a){this.table=a,this.head=this.table.tHead,this.tab=this.table.tBodies[0],this._template=null,this.lastIndex=0}get template(){return this._template}set template(a){this._template=a,this._template.attributes.forEach(a=>{this.appendBlankRow(a)})}createLabelCell(a){const b=document.createElement("th");return b.textContent=a,b}createDescriptionCell(a){const b=document.createElement("td");return b.innerHTML=a,b}createEditAllCell(a){const b=document.createElement("td");b.classList.add("editall");let c;return"sample_name"==a.general_name?(b.textContent="Must be unique.",b):"file"==a.type_?(c=createEditAllFileField(a),b.appendChild(c),b):(c=createAttributeField(a),c.onchange=function(){this.closest("tr").querySelectorAll("td.sample").forEach(a=>{a.querySelector(".attrfield").value=this.value}),SAMPLE_EDITOR.updateSampleTemplate(this)},b.appendChild(c),b)}appendBlankRow(a){const b=this.tab.insertRow();b.dataset.generalName=a.general_name,b.appendChild(this.createLabelCell(a.label)),b.appendChild(this.createEditAllCell(a)),b.appendChild(this.createDescriptionCell(a.description))}stretchHeader(){const a=this.head.querySelector("#samples-header-cell");a.style.display||(a.colSpan=parseInt(a.colSpan)+1),a.style.display=""}getRow(a){return this.tab.querySelector(`tr[data-general-name='${a}']`)}get currentIndex(){return this.lastIndex+1}addAttributeCell(a,b=null){const c=this.getRow(a.general_name).insertCell(this.lastIndex+2);c.classList.add("sample"),"template"==a.type_&&c.classList.add("template"),c.dataset.sample=this.currentIndex;const d=`sample+${this.currentIndex}+${a.general_name}`,e=createAttributeField(a,d,b=b);c.appendChild(e)}addSample(a=null){this.template.attributes.forEach(b=>{let c=null,d=null;null!==a&&("sample_name"==b.general_name?c=a.name:"short_description"==b.general_name?c=a.short_description:0<a.attributes.length&&(d=a.attributes.find(a=>a.general_name==b.general_name),null!==d&&(c=d.value))),this.addAttributeCell(b,c)}),this.stretchHeader(),this.lastIndex++}checkSample(a){let b=0;return this.getRow("sample_name").querySelectorAll("td.sample>input.attrfield").forEach(c=>{if(c.value==a)return void(b=parseInt(c.name.split("+")[1]))}),b}addSampleFromFile(a){const b=a.name.split(".")[0],c=b.split("_")[0],d=this.checkSample(c);if(!d){const a=JSON.parse(JSON.stringify(BLANK_SAMPLE));return a.name=c,void SAMPLE_EDITOR.addSample(a)}}updateTemplate(a){const b=a.querySelector(".attrfield"),c=a.dataset.sample,d=parseTemplateString(b.dataset.templateString);d.filter(a=>"const"!=a.type).forEach(a=>{let b=a.value;a.fieldValue=this.getRow(b).querySelector(`td.sample[data-sample='${c}']`).querySelector(".attrfield").value}),b.value=constructStringFromTemplate(d)}updateSampleTemplate(a){const b=a.closest("td");let c="td.sample.template";b.classList.contains("editall")||(c+=`[data-sample='${b.dataset.sample}']`),this.tab.querySelectorAll(c).forEach(a=>{this.updateTemplate(a)})}}function addBlankSample(){const a=parseInt(SAMPLE_EDITOR.rows[1].querySelectorAll("td.sample").length)+1;return TEMPLATE.attributes.forEach(b=>{const c=SAMPLE_EDITOR.querySelector(`tr[data-general-name='${b.general_name}']`),d=c.insertCell(c.cells.length-1);d.classList.add("sample"),d.dataset.sample=a,d.appendChild(createAttributeField(b))}),a}function newSample(){SAMPLE_EDITOR.addSample()}async function initTable(){const a=document.querySelector("#template-name").value;SAMPLE_EDITOR.template=await fetch(`/templates/json?name=${a}&use=sample_editor`).then(a=>a.json()).then(a=>a);const b=document.querySelector("#sample-names").value.split(",");b&&b.forEach(b=>{b&&fetch(`/samples/json?name=${b}&template_name=${a}`).then(a=>a.json()).then(a=>SAMPLE_EDITOR.addSample(a))})}const table=document.querySelector("#sample-editor"),SAMPLE_EDITOR=new SampleEditor(table);initTable();