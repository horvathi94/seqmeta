const SAMPLE_EDITOR=document.querySelector("#sample-editor").tBodies[0],TEMPLATE_ID=document.querySelector("#template-id").value,SAMPLE_NAME_ATTR={general_name:"name",label:"Sample name",description:"Unique name to differentiate between registered samples.",pattern:"\\w+",type_:"sample_name",value:""},SHORT_DESCRIPTION_ATTR={general_name:"short_description",label:"Short description",description:"A short description to more easily identify the sample.",type_:"text",value:""};function createAttributeField(e,t=""){let l;switch(e.type_){case"text":(l=new TextField(t)).setPattern(e.pattern);break;case"select":l=new SelectField(t,e.options);break;case"date":l=new DateField(t);break;case"template":(l=new TextField(t)).input.placeholder=e.template,l.input.setAttribute("template-string",e.template),l.addClasses(["template"]);break;case"sample_name":(l=new TextField(t)).pattern=e.pattern}return e.value?l.setValue(e.value):l.setValue(e.default),l.addClasses(["attrfield",e.general_name]),"template"!=e.type_&&l.input.addEventListener("change",function(){updateTemplateFields()},!1),l}function updateTemplateFields(e){Array.from(SAMPLE_EDITOR.querySelectorAll("td.sample.template")).forEach(e=>{let t=e.getAttribute("sample"),l=e.querySelector(".attrfield"),a=parseTemplateString(l.getAttribute("template-string"));a.filter(e=>"const"!=e.type).forEach(e=>{e.fieldValue=SAMPLE_EDITOR.querySelector(`td.sample.${e.value}[sample=${t}]`).querySelector(".attrfield").value}),l.value=constructStringFromTemplate(a)})}function createEditAllField(e){let t;return"sample_name"==e.type_?((t=document.createElement("p")).innerHTML="Must be unique.",t):((t=createAttributeField(e)).input.addEventListener("change",function(){this.closest("tr").querySelectorAll("td.sample").forEach(e=>{e.querySelector(".attrfield").value=this.value}),updateTemplateFields()},!1),t.input)}function createTextCell(e,t=[],l="td"){const a=document.createElement(l),n=(a.classList.add(t),document.createElement("p"));return n.innerHTML=e,a.appendChild(n),a}function createEditAllCell(e){const t=document.createElement("td");t.classList.add("editall");e=createEditAllField(e);return t.appendChild(e),t}function createAttributeRow(e){const t=document.createElement("tr");return t.classList.add(e.general_name),t.appendChild(createTextCell(e.label,classList=["title"],element="th")),t.appendChild(createEditAllCell(e)),t.appendChild(createTextCell(e.description,classList=["description"],element="td")),t}function initTable(){SAMPLE_EDITOR.appendChild(createAttributeRow(SAMPLE_NAME_ATTR)),SAMPLE_EDITOR.appendChild(createAttributeRow(SHORT_DESCRIPTION_ATTR)),fetch("/templates/json/"+TEMPLATE_ID).then(e=>e.json()).then(e=>{e.attributes.forEach(e=>{SAMPLE_EDITOR.appendChild(createAttributeRow(e))})})}function insertSampleCell(e,t=!0,l=0){const a=SAMPLE_EDITOR.querySelector("tr."+e.general_name),n=a.insertCell(a.cells.length-1);t=t?"new":"registered",n.classList.add("sample",e.general_name,t),n.setAttribute("sample",t+"-"+l),"template"==e.type_&&n.classList.add("template"),t=`sample+${t}+${l}+`+e.general_name,l=createAttributeField(e,t);n.appendChild(l.input)}async function addSample(t=0){const e=document.querySelector("#samples-header-cell");e.style.display||(e.colSpan=parseInt(e.colSpan)+1),e.style.display="";let l=!1,a,n={...SAMPLE_NAME_ATTR},r={...SHORT_DESCRIPTION_ATTR};t?(a=await fetch("/samples/json?id="+t).then(e=>e.json()).then(e=>e),n.value=a.name,r.value=a.short_description):(l=!0,t=SAMPLE_EDITOR.rows[1].querySelectorAll("td.sample.new").length+1),insertSampleCell(n,l=l,t),insertSampleCell(r,l=l,t),fetch("/templates/json/"+TEMPLATE_ID).then(e=>e.json()).then(e=>{e.attributes.forEach(e=>{l||(e.value=a.attributes[e.general_name]),insertSampleCell(e,l=l,t)})})}initTable();const sample_ids=document.querySelector("#sample-ids").value;sample_ids&&sample_ids.split(",").forEach(e=>{addSample(id=e)});